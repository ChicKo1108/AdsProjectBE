# 测试文档

## 概述

本项目使用 Jest 和 Supertest 进行API接口测试。测试文件位于 `test/` 目录下。

## 安装测试依赖

```bash
npm install --save-dev jest supertest
```

## 运行测试

### 运行所有测试
```bash
npm test
```

### 运行特定测试文件
```bash
npm run test:auth
npm run test:ad-creatives
npm run test:ad-plan
npm run test:ad-group
```

### adCreatives.test.js

包含以下测试场景：

#### 创建广告创意功能测试（9个测试用例）
- ✅ 成功创建广告创意 - 有效数据
- ❌ 创建失败 - 未提供认证令牌
- ❌ 创建失败 - 权限不足（普通用户）
- ❌ 创建失败 - 名称为空
- ❌ 创建失败 - Display ID为空
- ❌ 创建失败 - 状态值无效
- ❌ 创建失败 - 预算为负数
- ❌ 创建失败 - 名称已存在
- ❌ 创建失败 - Display ID已存在

#### 修改广告创意功能测试（8个测试用例）
- ✅ 成功修改 - 更新名称
- ✅ 成功修改 - 更新状态
- ✅ 成功修改 - 更新预算和成本
- ❌ 修改失败 - 广告创意ID无效
- ❌ 修改失败 - 广告创意不存在
- ❌ 修改失败 - 名称为空
- ❌ 修改失败 - 状态值无效
- ❌ 修改失败 - 预算为负数
- ❌ 修改失败 - 权限不足

#### 删除广告创意功能测试（5个测试用例）
- ✅ 成功删除广告创意
- ❌ 删除失败 - 广告创意ID无效
- ❌ 删除失败 - 广告创意不存在
- ❌ 删除失败 - 权限不足
- ❌ 删除失败 - 未提供认证令牌

#### 数据验证测试（3个测试用例）
- 所有数值字段的负数验证
- 数值字段边界值测试（零值）
- 大数值测试

### adPlan.test.js
包含以下测试场景：

#### 创建广告计划功能测试（9个测试用例）
- ✅ 成功创建广告计划 - 有效数据
- ❌ 创建失败 - 未提供认证令牌
- ❌ 创建失败 - 权限不足（普通用户）
- ❌ 创建失败 - 名称为空
- ❌ 创建失败 - 计划类型为空
- ❌ 创建失败 - 目标值无效
- ❌ 创建失败 - 价格策略无效
- ❌ 创建失败 - 投放类型为空
- ❌ 创建失败 - 预算为负数

#### 修改广告计划功能测试（7个测试用例）
- ✅ 成功修改 - 更新名称
- ✅ 成功修改 - 更新目标和策略
- ✅ 成功修改 - 更新预算和状态
- ❌ 修改失败 - 广告计划ID无效
- ❌ 修改失败 - 广告计划不存在
- ❌ 修改失败 - 目标值无效
- ❌ 修改失败 - 权限不足

#### 绑定广告组功能测试（5个测试用例）
- ✅ 成功绑定广告组
- ❌ 绑定失败 - 广告计划不存在
- ❌ 绑定失败 - 广告组ID列表为空
- ❌ 绑定失败 - 广告组不存在
- ❌ 绑定失败 - 权限不足

#### 删除广告组功能测试（3个测试用例）
- ✅ 成功删除广告组
- ❌ 删除失败 - 广告组中还有其他广告计划
- ❌ 删除失败 - 权限不足

#### 删除广告计划功能测试（3个测试用例）
- ✅ 成功删除广告计划
- ❌ 删除失败 - 广告计划不存在
- ❌ 删除失败 - 权限不足

#### 数据验证测试（3个测试用例）
- 枚举值验证（target和price_stratagy）
- 数值字段边界值测试
- 大数值测试

### adGroup.test.js
包含以下测试场景：

#### 创建广告组功能测试（8个测试用例）
- ✅ 成功创建广告组 - 有效数据
- ❌ 创建失败 - 未提供认证令牌
- ❌ 创建失败 - 权限不足（普通用户）
- ❌ 创建失败 - 名称为空
- ❌ 创建失败 - 名称只包含空格
- ❌ 创建失败 - 名称已存在
- ✅ 成功创建 - 长名称
- ✅ 成功创建 - 包含特殊字符

#### 修改广告组功能测试（7个测试用例）
- ✅ 成功修改广告组 - 更新名称
- ❌ 修改失败 - 广告组ID无效
- ❌ 修改失败 - 广告组不存在
- ❌ 修改失败 - 名称为空
- ❌ 修改失败 - 名称已存在
- ❌ 修改失败 - 权限不足
- ❌ 修改失败 - 未提供认证令牌

#### 查询广告组功能测试（5个测试用例）
- ✅ 成功查询广告组列表
- ✅ 成功查询单个广告组
- ❌ 查询失败 - 广告组不存在
- ❌ 查询失败 - 权限不足
- ❌ 查询失败 - 未提供认证令牌

#### 删除广告组功能测试（6个测试用例）
- ✅ 成功删除广告组 - 无关联广告计划
- ❌ 删除失败 - 存在关联的广告计划
- ❌ 删除失败 - 广告组ID无效
- ❌ 删除失败 - 广告组不存在
- ❌ 删除失败 - 权限不足
- ❌ 删除失败 - 未提供认证令牌

#### 批量操作测试（2个测试用例）
- 批量创建广告组
- 批量删除广告组

#### 数据完整性测试（2个测试用例）
- 创建广告组后自动设置时间戳
- 修改广告组后更新时间戳

#### 边界条件测试（3个测试用例）
- 最小长度名称（单字符）
- Unicode字符名称
- 包含换行符的名称

### 运行测试并生成覆盖率报告
```bash
npm test -- --coverage
```

## 测试文件说明

### auth.test.js

测试认证和用户管理相关功能，包括：

#### 登录功能测试
- ✅ 成功登录 - 有效的用户名和密码
- ❌ 登录失败 - 用户名为空
- ❌ 登录失败 - 密码为空
- ❌ 登录失败 - 用户不存在
- ❌ 登录失败 - 密码错误

#### 超管创建用户功能测试
- ✅ 成功创建用户 - 有效数据
- ❌ 创建用户失败 - 未提供认证令牌
- ❌ 创建用户失败 - 用户名为空
- ❌ 创建用户失败 - 密码为空
- ❌ 创建用户失败 - 姓名为空
- ❌ 创建用户失败 - 无效角色
- ❌ 创建用户失败 - 用户名已存在

#### 修改用户功能测试
- ✅ 成功修改用户 - 更新姓名
- ✅ 成功修改用户 - 更新密码
- ✅ 成功修改用户 - 更新角色
- ❌ 修改用户失败 - 用户ID无效
- ❌ 修改用户失败 - 用户不存在
- ❌ 修改用户失败 - 姓名为空
- ❌ 修改用户失败 - 无效角色
- ❌ 修改用户失败 - 未提供认证令牌

#### 权限验证测试
- ❌ 普通用户无法创建用户
- ❌ 普通用户无法修改用户

## 测试数据管理

### 测试前准备 (beforeAll)
- 清理测试数据库中的用户数据
- 创建测试超级管理员账户
- 获取管理员认证token

### 测试后清理 (afterAll)
- 清理所有测试数据
- 关闭数据库连接

## 测试覆盖的API接口

### 认证接口
- `POST /api/auth/login` - 用户登录

### 管理员用户管理接口
- `POST /api/admin/users` - 创建用户
- `PUT /api/admin/users/:id` - 修改用户

## 测试环境配置

测试使用与开发环境相同的数据库配置，但建议：

1. 使用独立的测试数据库
2. 在测试前后清理数据
3. 使用事务回滚确保数据隔离

## 注意事项

1. **数据库清理**: 每次测试运行前会清理用户表数据
2. **认证token**: 测试中使用真实的JWT token进行认证
3. **密码加密**: 测试用户密码使用bcrypt加密存储
4. **权限测试**: 包含超级管理员和普通用户的权限验证测试
5. **错误处理**: 测试各种错误场景和边界条件

## 扩展测试

可以基于现有测试框架添加更多测试：

- 广告计划管理测试
- 广告创意管理测试
- 账户管理测试
- 中间件测试
- 服务层单元测试

## 测试报告

运行测试后会生成：
- 控制台测试结果输出
- 代码覆盖率报告（coverage/ 目录）
- Jest测试报告